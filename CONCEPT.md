# Концепция MemCP: Универсальная долгосрочная память для проектов

## Суть проекта

**MemCP** — это универсальная система долгосрочной памяти для **любых проектов**, которая:

1. **Сохраняет информацию** из диалогов, кода, документации, задач
2. **Дедуплицирует** похожие записи (объединяет дубликаты)
3. **Оптимизирует** содержимое (сжимает, дистиллирует, фильтрует шум)
4. **Возвращает качественные данные** — коротко, по делу, релевантно запросу

## Как это работает

### Сохранение (Save)

Когда AI или разработчик сохраняет информацию:

```
1. Приходит запрос: "Причина бага: расхождение delay_unit/trigger_delay_unit"
2. Система проверяет:
   - Новизна (нет ли похожего?)
   - Полезность (будет ли это полезно?)
   - Дедупликация (если похожий факт уже есть → обновляем, а не создаем новый)
3. Сохраняет сжато и структурированно:
   - kind: "fact" (тип: факт/пример/правило)
   - scope: ["cart_sessions", "settings"] (область применения)
   - tags: ["bugfix", "unit"] (теги для поиска)
   - ttl: "2026-06-01" (срок жизни)
   - quality: {novelty: 0.74, usefulness: 0.81} (метрики качества)
```

### Поиск (Recall)

Когда нужна информация:

```
1. Запрос: "Найди информацию о CS-214 в cart_sessions"
2. Система ищет:
   - По проекту (изоляция данных)
   - По задаче (task_external_id)
   - По scope (область кода)
   - По тегам (signals)
   - По векторному сходству (embeddings)
3. Формирует bundle:
   - facts: короткие факты (≤200-300 символов)
   - few_shots: 1-3 примера решения
   - links: ссылки на ADR/документацию
   - confidence: уверенность в релевантности
4. Ограничивает по токенам (limit_tokens: 2000)
```

## Универсальность

### Поддержка любых проектов

- **Проект** = `project_key` (например: "insales", "demo", "my-project")
- Каждый проект изолирован (свои воспоминания)
- Можно использовать для:
  - Rails-легаси
  - Node.js проектов
  - Python проектов
  - Любых других

### Типы знаний (kind)

- `fact` — факты, правила, особенности
- `fewshot` — примеры решения проблем
- `pattern` — паттерны проектирования
- `adr_link` — ссылки на архитектурные решения
- `gotcha` — подводные камни, осторожность
- `rule` — правила кодирования, линтеры

## Текущая реализация (MVP Итерация 1)

### ✅ Реализовано

1. **Сохранение** (`POST /save`):
   - Upsert проекта по `project_key`
   - Сохранение `memory_record` с полями из ТЗ
   - Валидация `kind`
   - Поддержка `scope`, `tags`, `ttl`, `quality`, `meta`

2. **Поиск** (`POST /recall`):
   - Текстовый поиск по `content` (ILIKE)
   - Фильтрация по `project_key`, `task_external_id`, `scope`, `tags`
   - Формирование bundle (facts, few_shots, links)
   - Ограничение по токенам
   - Расчет confidence

3. **Изоляция данных**:
   - Каждый проект изолирован
   - Фильтрация по `project_id`

### ⚠️ В разработке (Итерация 2+)

1. **Дедупликация**:
   - SimHash/MinHash для обнаружения похожих записей
   - Upsert вместо создания дубликатов
   - Merge tags при обновлении

2. **Оптимизация (Judge/Distill)**:
   - LLM-as-a-judge для оценки новизны/полезности
   - Сжатие до ≤2k символов
   - Фильтрация шума

3. **Векторный поиск**:
   - Генерация embeddings (через FastAPI сервис или OpenAI)
   - pgvector cosine similarity
   - Гибридный поиск (BM25 + векторный)

4. **Санитайзинг**:
   - Удаление секретов (regex + detect-secrets)
   - Удаление ПДн
   - Quarantine для подозрительных записей

5. **Гигиена (воркеры)**:
   - TTL-сборщик (удаление устаревших)
   - Dedup-пакет (периодическая кластеризация)
   - Quality-scorer (пересчет полезности)

## Примеры использования

### Пример 1: Rails-легаси

```ruby
# Сохранение факта
save({
  project_key: "insales",
  kind: "fact",
  content: "В CartSessions::Setting delay_unit и trigger_delay_unit должны совпадать",
  scope: ["cart_sessions", "settings"],
  tags: ["bugfix", "unit"],
  ttl: "2026-06-01"
})

# Поиск
recall({
  project_key: "insales",
  task_external_id: "CS-214",
  repo_path: "app/services/cart_sessions",
  signals: ["nil-delay", "unit-mismatch"]
})
# → Возвращает релевантные факты и few-shots
```

### Пример 2: Node.js проект

```javascript
// Сохранение
save({
  project_key: "my-node-app",
  kind: "gotcha",
  content: "В Express не использовать body-parser в новых версиях",
  scope: ["api", "middleware"],
  tags: ["express", "gotcha"]
})

// Поиск
recall({
  project_key: "my-node-app",
  repo_path: "src/api",
  signals: ["express"]
})
```

### Пример 3: Python проект

```python
# Сохранение
save({
  "project_key": "data-pipeline",
  "kind": "fewshot",
  "content": "1. Использовать pandas для чтения CSV\n2. Применить фильтр\n3. Сохранить в Parquet",
  "scope": ["etl", "pandas"],
  "tags": ["data-processing"]
})
```

## Преимущества

1. **Коллективная память**: опыт команды накапливается
2. **Быстрый доступ**: релевантная информация в несколько кликов
3. **Автоматическая оптимизация**: система сама фильтрует и сжимает
4. **Изоляция**: данные проектов не смешиваются
5. **Масштабируемость**: работает для любого количества проектов

## Архитектура

```
Cursor IDE (MCP tools)
    ↓
Ruby MCP Server (STDIO)
    ↓
Rails Core API (POST /save, /recall)
    ↓
PostgreSQL + pgvector (хранилище)
    ↓
[Будущее] FastAPI Embeddings Service
    ↓
[Будущее] Sidekiq Workers (dedup, TTL, quality)
```

## Следующие шаги

Для полноценной работы нужно:

1. **Векторный поиск** (embeddings + pgvector)
2. **Дедупликация** (SimHash, upsert логика)
3. **Judge/Distill** (LLM оценка качества)
4. **Санитайзинг** (удаление секретов)
5. **Воркеры** (фоновая обработка)

---

**Текущий статус**: MVP Итерация 1 — базовое сохранение и поиск работают, но без дедупликации и оптимизации.

