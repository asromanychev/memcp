service: memcp

image: registry.example.com/memcp/app

registry:
  server: registry.example.com
  username:
    - KAMAL_REGISTRY_USERNAME
  password:
    - KAMAL_REGISTRY_PASSWORD

env:
  clear:
    RAILS_ENV: production
    RACK_ENV: production
    BUNDLE_WITHOUT: development
    SOLID_QUEUE_IN_PUMA: true
  secret:
    - RAILS_MASTER_KEY

servers:
  app:
    hosts:
      - 192.0.2.10 # staging application host
      - 198.51.100.20 # production application host
    labels:
      role: web

destinations:
  staging:
    servers:
      app:
        hosts:
          - 192.0.2.10 # staging application host
    env:
      clear:
        RAILS_LOG_LEVEL: info
      secret:
        - STAGING_RAILS_MASTER_KEY
        - STAGING_DATABASE_URL
        - STAGING_SOLID_QUEUE_DATABASE_URL
        - STAGING_SOLID_CACHE_DATABASE_URL
        - STAGING_SOLID_CABLE_DATABASE_URL
  production:
    servers:
      app:
        hosts:
          - 198.51.100.20 # production application host
    env:
      clear:
        RAILS_LOG_LEVEL: warn
      secret:
        - PRODUCTION_RAILS_MASTER_KEY
        - PRODUCTION_DATABASE_URL
        - PRODUCTION_SOLID_QUEUE_DATABASE_URL
        - PRODUCTION_SOLID_CACHE_DATABASE_URL
        - PRODUCTION_SOLID_CABLE_DATABASE_URL

hooks:
  deploy:
    before_migrate:
      - bin/rails db:prepare
    after_migrate:
      - bin/ci/smoke "${KAMAL_DESTINATION}"
  rollback:
    after:
      - bin/ci/smoke "${KAMAL_DESTINATION}"

aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole"

builder:
  arch: amd64

