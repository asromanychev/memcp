#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Ensure requested Bundler version is present
if [ -n "${BUNDLER_VERSION:-}" ]; then
  if ! gem list -i bundler -v "${BUNDLER_VERSION}" > /dev/null 2>&1; then
    gem install bundler -v "${BUNDLER_VERSION}" --no-document
  fi
fi

# Ensure Ruby gems are installed
if [ -f "Gemfile" ]; then
  bundle check || bundle install
fi

# Wait for the database to be ready
# Support both DATABASE_URL and DB_HOST/DB_PORT/DB_USER
if [ -n "${DATABASE_URL:-}" ]; then
  db_host=$(ruby -e 'require "uri"; uri = URI(ENV["DATABASE_URL"]); puts(uri.host || "localhost")')
  db_port=$(ruby -e 'require "uri"; uri = URI(ENV["DATABASE_URL"]); puts(uri.port || 5432)')
  db_user=$(ruby -e 'require "uri"; uri = URI(ENV["DATABASE_URL"]); puts(uri.user || "postgres")')
elif [ -n "${DB_HOST:-}" ]; then
  db_host="${DB_HOST}"
  db_port="${DB_PORT:-5432}"
  db_user="${DB_USER:-postgres}"
else
  db_host="localhost"
  db_port="5432"
  db_user="postgres"
fi

if [ -n "${db_host:-}" ]; then
  until pg_isready -q -h "$db_host" -p "$db_port" -U "$db_user"; do
    echo "Waiting for database at ${db_host}:${db_port}..."
    sleep 1
  done
  echo "Database is ready at ${db_host}:${db_port}"
fi

# If running the rails server then create or migrate existing database
if [ "${1:-}" = "./bin/rails" ] && [ "${2:-}" = "server" ]; then
  ./bin/rails db:prepare
  
  # Create and setup queue database
  if [ -n "${DATABASE_URL:-}" ]; then
    db_url=$(echo "$DATABASE_URL" | sed 's|/memcp_development|/memcp_development_queue|')
    
    # Create queue database if it doesn't exist
    db_host=$(ruby -e 'require "uri"; uri = URI(ENV["DATABASE_URL"]); puts(uri.host || "localhost")')
    db_port=$(ruby -e 'require "uri"; uri = URI(ENV["DATABASE_URL"]); puts(uri.port || 5432)')
    db_user=$(ruby -e 'require "uri"; uri = URI(ENV["DATABASE_URL"]); puts(uri.user || "postgres")')
    db_pass=$(ruby -e 'require "uri"; uri = URI(ENV["DATABASE_URL"]); puts(uri.password || "")')
    
    PGPASSWORD="${db_pass}" psql -h "$db_host" -p "$db_port" -U "$db_user" -d postgres -tc "SELECT 1 FROM pg_database WHERE datname = 'memcp_development_queue'" | grep -q 1 || \
    PGPASSWORD="${db_pass}" psql -h "$db_host" -p "$db_port" -U "$db_user" -d postgres -c "CREATE DATABASE memcp_development_queue;"
    
    # Load queue schema using Rails
    if [ -f "db/queue_schema.rb" ]; then
      DATABASE_URL="${db_url}" ./bin/rails db:schema:load
    fi
  fi
fi

exec "${@}"
