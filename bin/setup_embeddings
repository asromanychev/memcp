#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
DEFAULT_MODEL_FILENAME="Qwen3-Embedding-0.6B-Q8_0.gguf"
DEFAULT_MODEL_DIR="${ROOT_DIR}/tmp/embeddings"

MODEL_PATH="${MEMORY_EMBEDDING_MODEL_PATH:-${DEFAULT_MODEL_DIR}/${DEFAULT_MODEL_FILENAME}}"
MODEL_URL_DEFAULT="https://huggingface.co/Qwen/Qwen3-Embedding-0.6B-GGUF/resolve/main/${DEFAULT_MODEL_FILENAME}?download=1"
MODEL_URL="${MEMORY_EMBEDDING_MODEL_URL:-$MODEL_URL_DEFAULT}"
CHECKSUM="${MEMORY_EMBEDDING_MODEL_SHA256:-}"

mkdir -p "$(dirname "$MODEL_PATH")"
TEMP_PATH="${MODEL_PATH}.download"

cleanup() {
  rm -f "$TEMP_PATH"
}
trap cleanup EXIT

if [ -f "$MODEL_PATH" ]; then
  echo "Embedding model already present at $MODEL_PATH"
else
  echo "Downloading embedding model from $MODEL_URL"
  curl_args=(
    --fail
    --location
    --show-error
    --retry 3
    --retry-delay 2
    --output "$TEMP_PATH"
  )

  if [ -n "${HF_TOKEN:-}" ]; then
    curl_args+=(-H "Authorization: Bearer ${HF_TOKEN}")
  fi

  curl "${curl_args[@]}" "$MODEL_URL"
  mv "$TEMP_PATH" "$MODEL_PATH"
  echo "Model downloaded to $MODEL_PATH"
fi

if [ -n "$CHECKSUM" ]; then
  echo "Verifying SHA256 checksum..."
  if command -v sha256sum >/dev/null 2>&1; then
    echo "$CHECKSUM  $MODEL_PATH" | sha256sum --check --strict
  else
    echo "$CHECKSUM  $MODEL_PATH" | shasum -a 256 --check
  fi
  echo "Checksum OK."
fi

echo "Embedding model ready: $MODEL_PATH"

